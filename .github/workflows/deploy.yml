# name: Build and deploy to GitHub Pages

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - name: Checkout 🛎️
#         uses: actions/checkout@v2.3.1

#       - name: Install dependencies 🔧
#         run: npm install 

#       - name: Linting 🚨
#         run: npm run lint:js

#       - name: Build 🏗️
#         run: |
#           echo "REACT_APP_HOST_BACK=${{ secrets.REACT_APP_HOST_BACK }}" >> $GITHUB_ENV
#           echo "REACT_APP_HOST_BACK is set to $REACT_APP_HOST_BACK"
#           npm run build
#         env:
#           REACT_APP_HOST_BACK: ${{ secrets.REACT_APP_HOST_BACK }}

#       - name: Deploy 🚀
#         uses: JamesIves/github-pages-deploy-action@4.1.0
#         with:
#           branch: gh-pages
#           folder: build
on:
  push:
    branches:
      - main
name: 🚀 Deploy website on push
jobs:
  web-deploy:
    name: 🎉 Deploy
    runs-on: ubuntu-latest
    steps:
    - name: 🚚 Get latest code
      uses: actions/checkout@v3 
    - name: Install SSH Key
      uses: shimataro/ssh-key-action@v2
      with:
        key: ${{ secrets.SSH_KEY }} 
        known_hosts: unnecessary
    - name: Adding Known Hosts
      run: ssh-keyscan -p 22 -H ${{ secrets.SSH_HOST }}  >> ~/.ssh/known_hosts    
      
    - name: 🚀 Deploy website on push
      run: |
        ssh ${{ secrets.USER_NAME }}@${{ secrets.SSH_HOST }} "cd /var/www/navchora/crm.navchora.com.ua && pm2 stop navchora-crm || true && pm2 delete navchora-crm || true"
        rsync  --archive --verbose --compress -c --delete-after --exclude=.git* --exclude=.git/ --exclude=README.es.md --exclude=README.en.md --exclude=README.pl.md --exclude=README.md --exclude=.gitignore --exclude=node_modules --exclude=ecosystem.config.js --exclude=.env ./ ${{ secrets.USER_NAME }}@${{ secrets.SSH_HOST }}:/var/www/navchora/crm.navchora.com.ua
        ssh ${{ secrets.USER_NAME }}@${{ secrets.SSH_HOST }} "cd /var/www/navchora/crm.navchora.com.ua && npm install && npm run build && pm2 start ecosystem.config.js"
      